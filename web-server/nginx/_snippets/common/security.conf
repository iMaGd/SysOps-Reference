# Sensible security headers
add_header X-Frame-Options "SAMEORIGIN" always;
add_header X-Content-Type-Options "nosniff" always;
add_header Referrer-Policy "no-referrer-when-downgrade" always;
add_header X-XSS-Protection "1; mode=block" always;
# Disables geolocation, accelerometer and microphone access from all origins
add_header Permissions-Policy "accelerometer=(), geolocation=(), microphone=()" always;

# Upgrade Insecure Requests
add_header Content-Security-Policy 'upgrade-insecure-requests';

# Allow Let's Encrypt HTTP-01 challenge without forcing HTTPS
location ^~ /.well-known/acme-challenge/ {
    default_type "text/plain";
    allow all;
}

# Deny access to hidden/system files
location ~ /\.(?!well-known) {
    deny all;
}

# Block common sensitive files & dev artifacts
location ~* ^/(composer\.(json|lock)|package\.json|yarn\.lock|dump.sql|Dockerfile|Makefile)$ {
    deny all;
}

location ~ /xmlrpc.php$ {
    deny all;
}

# Prevent direct access to storage/runtime and config (served by PHP only)
location ^~ /storage/ { deny all; }
location ^~ /vendor/  { deny all; }
location ^~ /config/  { deny all; }
