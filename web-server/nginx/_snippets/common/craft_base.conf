# Common routing
index index.php index.html;

location / {
    try_files $uri $uri/ /index.php?$args;
}

location ~* \.(?:ico|gif|jpe?g|png|svg|webp|avif)$ {
    expires 30d;
    access_log off;
    add_header Cache-Control "public, max-age=2592000, immutable";
}

location ~* \.(?:css|js)$ {
    expires 7d;
    access_log off;
    add_header Cache-Control "public, max-age=604800, immutable";
}

# PHP-FPM (per-tenant socket & PHP version)
location ~ \.php$ {
    try_files $fastcgi_script_name =404;

    include fastcgi_params;
    fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;

    # Preserve client scheme/IP if you're behind a CDN
    fastcgi_param HTTPS                     $origin_proto if_not_empty;
    fastcgi_param HTTP_X_FORWARDED_PROTO    $origin_proto;
    fastcgi_param HTTP_X_FORWARDED_FOR      $proxy_add_x_forwarded_for;

    # Dynamic PHP socket: /run/php/php8.3-fpm-user1.sock  -> via vars
    fastcgi_pass unix:/run/php/php${php_ver}-fpm-${tenant}.sock;

    # Useful buffers/timeouts for Craft (CP, image transforms)
    fastcgi_buffers 16 16k;
    fastcgi_buffer_size 32k;
    fastcgi_connect_timeout 300;
    fastcgi_send_timeout 300;
    fastcgi_read_timeout 300;
}

# Error handling: let Craft render 404/50x via index.php
error_page 404 /index.php;
error_page 500 502 503 504 /index.php;
